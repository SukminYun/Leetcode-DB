name: Convert Py to Jupyter Notebook

on:
  push:
    paths:
      - '**.py'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # 전체 히스토리를 가져옵니다

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run conversion script
      run: |
        # [수정됨] 최근 커밋 1개가 아니라, 최근 2개의 커밋 범위를 뒤져서 .py 파일을 찾습니다.
        # LeetHub가 코드 -> 리드미 순으로 2번 커밋하기 때문입니다.
        CHANGED_FILES=$(git diff --name-only HEAD~2 HEAD | grep '\.py$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No .py files found in the last 2 commits."
          # 혹시 커밋이 1개만 발생했을 경우를 대비해 한 번 더 체크 (안전장치)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
        fi

        if [ -z "$CHANGED_FILES" ]; then
          echo "Still no .py files found. Skipping."
        else
          echo "Processing files: $CHANGED_FILES"
          python convert.py $CHANGED_FILES
        fi

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # 디버깅: 현재 상태 확인
        echo ">> Checking git status before add:"
        git status
        
        # 모든 변경사항 스테이징
        git add .
        
        # 디버깅: 스테이징 후 상태 확인
        echo ">> Checking git status after add:"
        git status
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Auto-convert to Notebook via GitHub Action"
          git pull --rebase origin main
          git push origin main
        fi

        
